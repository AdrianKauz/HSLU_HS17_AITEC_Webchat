$(document).ready(function(){chat.init()});var chat={data:{lastID:0,noActivity:0},init:function(){$("#name").defaultText("Nickname"),$("#email").defaultText("Email (Gravatars are Enabled)"),chat.data.jspAPI=$("#chatLineHolder").jScrollPane({verticalDragMinHeight:12,verticalDragMaxHeight:12}).data("jsp");var t=!1;$("#loginForm").submit(function(){return!t&&(t=!0,$.chatPOST("login",$(this).serialize(),function(a){t=!1,a.error?chat.displayError(a.error):chat.login(a.name,a.gravatar)}),!1)}),$("#submitForm").submit(function(){var a=$("#chatText").val();if(0==a.length)return!1;if(t)return!1;t=!0;var e="t"+Math.round(1e6*Math.random()),n={id:e,author:chat.data.name,gravatar:chat.data.gravatar,text:a.replace(/</g,"&lt;").replace(/>/g,"&gt;")};return chat.addChatLine($.extend({},n)),$.chatPOST("submitChat",$(this).serialize(),function(a){t=!1,$("#chatText").val(""),$("div.chat-"+e).remove(),n.id=a.insertID,chat.addChatLine($.extend({},n))}),!1}),$("a.logoutButton").live("click",function(){return $("#chatTopBar > span").fadeOut(function(){$(this).remove()}),$("#submitForm").fadeOut(function(){$("#loginForm").fadeIn()}),$.chatPOST("logout"),!1}),$.chatGET("checkLogged",function(t){t.logged&&chat.login(t.loggedAs.name,t.loggedAs.gravatar)}),function t(){chat.getChats(t)}(),function t(){chat.getUsers(t)}()},login:function(t,a){chat.data.name=t,chat.data.gravatar=a,$("#chatTopBar").html(chat.render("loginTopBar",chat.data)),$("#loginForm").fadeOut(function(){$("#submitForm").fadeIn(),$("#chatText").focus()})},render:function(t,a){var e=[];switch(t){case"loginTopBar":e=['<span><img src="',a.gravatar,'" width="23" height="23" />','<span class="name">',a.name,'</span><a href="" class="logoutButton rounded">Logout</a></span>'];break;case"chatLine":e=['<div class="chat chat-',a.id,'"><span class="gravatar"><img src="',a.gravatar,'" width="23" height="23" onload="this.style.visibility=\'visible\'" />','</span><span class="author">',a.author,'</span><span class="time">',a.time,'</span><span class="text">',a.text,"</span></div>"];break;case"user":e=['<div class="user" title="',a.name,'"><img src="',a.gravatar,'" width="30" height="30" onload="this.style.visibility=\'visible\'" /></div>']}return e.join("")},addChatLine:function(t){var a=new Date;t.time&&a.setUTCHours(t.time.hours,t.time.minutes),t.time=(a.getHours()<10?"0":"")+a.getHours()+":"+(a.getMinutes()<10?"0":"")+a.getMinutes();var e=chat.render("chatLine",t),n=$("#chatLineHolder .chat-"+t.id);if(n.length&&n.remove(),chat.data.lastID||$("#chatLineHolder p").remove(),"t"!=t.id.toString().charAt(0)){var i=$("#chatLineHolder .chat-"+(+t.id-1));i.length?i.after(e):chat.data.jspAPI.getContentPane().append(e)}else chat.data.jspAPI.getContentPane().append(e);chat.data.jspAPI.reinitialise(),chat.data.jspAPI.scrollToBottom(!0)},getChats:function(t){$.chatGET("getChats",{lastID:chat.data.lastID},function(a){for(var e=0;e<a.chats.length;e++)chat.addChatLine(a.chats[e]);a.chats.length?(chat.data.noActivity=0,chat.data.lastID=a.chats[e-1].id):chat.data.noActivity++,chat.data.lastID||chat.data.jspAPI.getContentPane().html('<p class="noChats">No chats yet</p>');var n=1e3;chat.data.noActivity>3&&(n=2e3),chat.data.noActivity>10&&(n=5e3),chat.data.noActivity>20&&(n=15e3),setTimeout(t,n)})},getUsers:function(t){$.chatGET("getUsers",function(a){for(var e=[],n=0;n<a.users.length;n++)a.users[n]&&e.push(chat.render("user",a.users[n]));var i="";i=a.total<1?"No one is online":a.total+" "+(1==a.total?"person":"people")+" online",e.push('<p class="count">'+i+"</p>"),$("#chatUsers").html(e.join("")),setTimeout(t,15e3)})},displayError:function(t){var a=$("<div>",{id:"chatErrorMessage",html:t});a.click(function(){$(this).fadeOut(function(){$(this).remove()})}),setTimeout(function(){a.click()},5e3),a.hide().appendTo("body").slideDown()}};$.chatPOST=function(t,a,e){$.post("php/ajax.php?action="+t,a,e,"json")},$.chatGET=function(t,a,e){$.get("php/ajax.php?action="+t,a,e,"json")},$.fn.defaultText=function(t){var a=this.eq(0);return a.data("defaultText",t),a.focus(function(){a.val()==t&&a.val("").removeClass("defaultText")}).blur(function(){""!=a.val()&&a.val()!=t||a.addClass("defaultText").val(t)}),a.blur()};